<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fasal-Sarathi AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .app-container {
            max-width: 420px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .main-content {
            flex-grow: 1;
        }
        .nav-item.active {
            color: #2563EB; /* blue-600 */
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .chat-user {
            background-color: #DBEAFE; /* blue-100 */
            align-self: flex-end;
        }
        .chat-ai {
            background-color: #F3F4F6; /* gray-100 */
            align-self: flex-start;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="app-container bg-white">
        <!-- Header -->
        <header class="bg-green-700 text-white p-4 flex items-center justify-between shadow-md">
            <div>
                <h1 class="text-xl font-bold">Fasal-Sarathi AI</h1>
                <p class="text-xs opacity-80">Your Personal Farming Expert</p>
            </div>
            <div class="text-right">
                 <p id="current-time" class="text-sm font-semibold"></p>
                 <p class="text-xs opacity-80">Jaipur, Rajasthan</p>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content p-4 pb-20 overflow-y-auto">
            <!-- Content will be rendered here by JavaScript -->
        </main>

        <!-- Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white border-t border-gray-200 flex justify-around p-2 shadow-inner" style="max-width: 420px;">
            <button data-page="home" class="nav-item active flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span class="text-xs mt-1">Home</span>
            </button>
            <button data-page="diagnose" class="nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>
                <span class="text-xs mt-1">Diagnose</span>
            </button>
            <button data-page="chatbot" class="nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.5A4.5 4.5 0 0 0 18 2c-1.5 0-2.75 1.06-4 1.06C8 2 2 10 2 14.5a4.5 4.5 0 0 0 4.5 4.5c1.25 0 2.5-1.06 4-1.06Z"></path><path d="M12 20.94c-1.5 0-2.75 1.06-4 1.06-3 0-6-8-6-12.5A4.5 4.5 0 0 1 6 2c1.5 0 2.75 1.06 4 1.06 6 0 12-8 12-12.5"></path></svg>
                <span class="text-xs mt-1">Ask AI</span>
            </button>
            <button data-page="market" class="nav-item flex flex-col items-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span class="text-xs mt-1">Market</span>
            </button>
        </nav>
    </div>

    <script type="module">
        const mainContent = document.getElementById('main-content');
        const navItems = document.querySelectorAll('.nav-item');
        const timeDisplay = document.getElementById('current-time');

        // --- Mock Data & State ---
        const MOCK_USER = {
            name: "Ramesh Kumar",
            farmSize: "5 Acres",
            crop: "Wheat (‡§ó‡•á‡§π‡•Ç‡§Ç)"
        };

        const MOCK_WEATHER = {
            temp: "31¬∞C",
            condition: "Sunny with light clouds",
            icon: "‚òÄÔ∏è"
        };
        
        const MOCK_MARKET = {
            crop: "Wheat",
            todayPrice: 2350,
            unit: "per Quintal",
            market: "Jaipur Anaj Mandi"
        };

        const MOCK_DAP = [
            { time: "Morning", task: "Irrigate the west field for 1 hour. Soil moisture is low.", completed: true, icon: "üíß" },
            { time: "Afternoon", task: "Scout for yellow rust infestation on leaves.", completed: false, icon: "üîç" },
            { time: "Evening", task: "Prepare sprayer for tomorrow's micronutrient application.", completed: false, icon: "üåø" },
        ];
        
        // --- Gemini API Configuration ---
        const API_KEY = ""; // Leave empty, will be handled by the environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // --- Helper function for API calls with retry ---
        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    console.error(`API call attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        return "Sorry, I'm having trouble connecting. Please try again later.";
                    }
                }
            }
        }

        // --- Page Templates ---

        const homePageTemplate = `
            <div class="space-y-4">
                <!-- Welcome Card -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h2 class="text-xl font-bold text-green-800">Namaste, ${MOCK_USER.name}</h2>
                    <p class="text-sm text-gray-600">${MOCK_USER.farmSize} | ${MOCK_USER.crop}</p>
                    <div class="mt-2 text-sm text-gray-700 flex items-center">${MOCK_WEATHER.icon} ${MOCK_WEATHER.temp}, ${MOCK_WEATHER.condition}</div>
                </div>

                <!-- Dynamic Action Plan (DAP) Card -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-blue-800 mb-3">Today's Action Plan (‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ)</h3>
                    <div id="dap-list" class="space-y-3">
                        ${MOCK_DAP.map(item => `
                            <div class="flex items-start space-x-3">
                                <div class="text-2xl">${item.icon}</div>
                                <div class="flex-1">
                                    <p class="font-semibold ${item.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${item.task}</p>
                                    <p class="text-xs text-gray-500">${item.time}</p>
                                </div>
                                <input type="checkbox" ${item.completed ? 'checked' : ''} class="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        const diagnosePageTemplate = `
            <div class="space-y-4 text-center">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-yellow-800 mb-2">Camera Vaidya (‡§ï‡•à‡§Æ‡§∞‡§æ ‡§µ‡•à‡§¶‡•ç‡§Ø)</h3>
                    <p class="text-sm text-gray-600">Upload a photo of the affected plant leaf. Our AI will diagnose the problem.</p>
                </div>
                <div class="flex justify-center">
                    <img id="preview-image" src="https://placehold.co/300x200/e2e8f0/94a3b8?text=Upload+Image" class="rounded-lg max-w-full h-auto border-2 border-dashed">
                </div>
                <input type="file" id="image-upload" class="hidden" accept="image/*">
                <button id="upload-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    Choose Photo
                </button>
                <div id="diagnosis-result" class="text-left mt-4"></div>
            </div>
        `;

        const chatbotPageTemplate = `
            <div class="flex flex-col h-[calc(100vh-200px)]">
                 <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <h3 class="text-lg font-bold text-green-800">Krishi-Gyaan AI (‡§ï‡•É‡§∑‡§ø-‡§ú‡•ç‡§û‡§æ‡§®)</h3>
                    <p class="text-sm text-gray-600">Ask me anything about farming!</p>
                </div>
                <div id="chat-window" class="flex-1 overflow-y-auto p-2 bg-gray-50 rounded-lg flex flex-col space-y-3">
                    <!-- Chat messages will appear here -->
                    <div class="chat-bubble chat-ai">Namaste! How can I help you today?</div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <input type="text" id="chat-input" class="flex-1 border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Type your question...">
                    <button id="send-chat" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Send</button>
                </div>
            </div>
        `;

        const marketPageTemplate = `
            <div class="space-y-4">
                <!-- Current Price -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                    <h3 class="text-lg font-bold text-purple-800">Today's Market Price</h3>
                    <p class="text-sm text-gray-600">${MOCK_MARKET.market}</p>
                    <div class="my-3">
                        <p class="text-4xl font-bold text-purple-900">‚Çπ${MOCK_MARKET.todayPrice}</p>
                        <p class="text-gray-600">${MOCK_MARKET.unit}</p>
                    </div>
                    <p class="text-xs text-gray-500">Crop: ${MOCK_MARKET.crop}</p>
                </div>

                <!-- AI Price Prediction -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">AI Market Intelligence</h3>
                     <p class="text-sm text-gray-600 mb-3">AI prediction for the next harvest season (March/April 2026).</p>
                    <div id="market-prediction" class="text-gray-700 bg-white p-3 rounded-md min-h-[100px] flex items-center justify-center">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        `;
        
        // --- Router & Page Rendering ---
        function renderPage(page) {
            mainContent.innerHTML = '';
            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');

            switch (page) {
                case 'home':
                    mainContent.innerHTML = homePageTemplate;
                    break;
                case 'diagnose':
                    mainContent.innerHTML = diagnosePageTemplate;
                    addDiagnoseEventListeners();
                    break;
                case 'chatbot':
                    mainContent.innerHTML = chatbotPageTemplate;
                    addChatbotEventListeners();
                    break;
                case 'market':
                    mainContent.innerHTML = marketPageTemplate;
                    fetchMarketPrediction();
                    break;
            }
        }
        
        // --- Event Listeners & Logic ---
        
        function addDiagnoseEventListeners() {
            const uploadButton = document.getElementById('upload-button');
            const imageUpload = document.getElementById('image-upload');
            const previewImage = document.getElementById('preview-image');
            const resultDiv = document.getElementById('diagnosis-result');

            uploadButton.addEventListener('click', () => imageUpload.click());

            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        resultDiv.innerHTML = `<div class="flex items-center justify-center p-4"><div class="loader"></div> <p class="ml-2">Analyzing... please wait.</p></div>`;
                        getDiagnosis(file);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        async function getDiagnosis(file) {
            const resultDiv = document.getElementById('diagnosis-result');
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const payload = {
                    contents: [{
                        parts: [
                            { text: "You are an expert agronomist for Indian crops. Analyze this image of a plant leaf. Identify any disease, pest, or nutrient deficiency. Provide the name, severity (Low, Medium, High), a brief description, and a simple, step-by-step remedy for an Indian farmer. If the image is healthy or not a plant, say so. Format the response with clear headings." },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]
                    }]
                };
                
                const responseText = await callGeminiAPI(payload);
                // Simple markdown to HTML conversion
                let htmlResponse = responseText
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>') // Bold
                    .replace(/\n/g, '<br>');
                    
                resultDiv.innerHTML = `<div class="bg-gray-100 p-4 rounded-lg">${htmlResponse}</div>`;
            };
        }
        
        function addChatbotEventListeners() {
            const sendButton = document.getElementById('send-chat');
            const chatInput = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');

            const sendMessage = async () => {
                const query = chatInput.value.trim();
                if (!query) return;

                // Add user message to window
                chatWindow.innerHTML += `<div class="chat-bubble chat-user">${query}</div>`;
                chatInput.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;

                // Add loading indicator
                chatWindow.innerHTML += `<div id="ai-thinking" class="chat-bubble chat-ai flex items-center"><div class="loader !w-5 !h-5 !border-2"></div></div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    systemInstruction: {
                        parts: [{ text: "You are 'Krishi-Gyaan GPT', a helpful AI assistant for Indian farmers. Provide clear, concise, and practical answers to agricultural questions in simple language. You can answer in Hindi or Hinglish if the user asks." }]
                    }
                };
                
                const responseText = await callGeminiAPI(payload);
                document.getElementById('ai-thinking').remove();
                
                // Add AI response
                chatWindow.innerHTML += `<div class="chat-bubble chat-ai">${responseText.replace(/\n/g, '<br>')}</div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        async function fetchMarketPrediction() {
            const predictionDiv = document.getElementById('market-prediction');
            const prompt = `It is currently September 9, 2025. Given the current price of Wheat in Jaipur, India is ‚Çπ${MOCK_MARKET.todayPrice}/quintal, act as an agricultural market analyst. Predict the price trend for the next harvest season (March/April 2026). Will it be higher, lower, or stable? Provide a short, one-paragraph explanation based on typical factors like monsoon performance, government MSP, and global demand.`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const responseText = await callGeminiAPI(payload);
            
            predictionDiv.innerHTML = responseText.replace(/\n/g, '<br>');
        }
        
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', hour: '2-digit', minute: '2-digit', hour12: true };
            timeDisplay.textContent = new Intl.DateTimeFormat('en-IN', options).format(now);
        }

        // --- Initialization ---
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                renderPage(item.dataset.page);
            });
        });

        // Initial render
        renderPage('home');
        updateTime();
        setInterval(updateTime, 1000 * 60);
    </script>
</body>
</html>
